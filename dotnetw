#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
DOTNET_DIR="$ROOT_DIR/.dotnet"
DOTNET_CLI_HOME_DIR="$ROOT_DIR/.tmp/dotnet-cli-home"
NUGET_PACKAGES_DIR="$ROOT_DIR/.tmp/nuget-packages"
XDG_DATA_HOME_DIR="$ROOT_DIR/.tmp/xdg-data"
XDG_CONFIG_HOME_DIR="$ROOT_DIR/.tmp/xdg-config"

if [[ ! -x "$DOTNET_DIR/dotnet" ]]; then
  echo "dotnet not found at $DOTNET_DIR/dotnet"
  echo "Run: ./scripts/install-dotnet.sh"
  exit 1
fi

export DOTNET_ROOT="$DOTNET_DIR"
export PATH="$DOTNET_DIR:$PATH"
export DOTNET_CLI_HOME="$DOTNET_CLI_HOME_DIR"
export NUGET_PACKAGES="$NUGET_PACKAGES_DIR"
export HOME="$DOTNET_CLI_HOME_DIR"
export XDG_DATA_HOME="$XDG_DATA_HOME_DIR"
export XDG_CONFIG_HOME="$XDG_CONFIG_HOME_DIR"
export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
export DOTNET_NOLOGO=1

mkdir -p "$DOTNET_CLI_HOME_DIR" "$NUGET_PACKAGES_DIR" "$XDG_DATA_HOME_DIR" "$XDG_CONFIG_HOME_DIR"

# ModBuildConfig looks for a custom GamePath in "$HOME/stardewvalley.targets" on non-Windows.
# Keep a versioned copy in the repo root and mirror it into DOTNET_CLI_HOME/HOME for builds.
if [[ -f "$ROOT_DIR/stardewvalley.targets" ]]; then
  cp -f "$ROOT_DIR/stardewvalley.targets" "$DOTNET_CLI_HOME_DIR/stardewvalley.targets"
fi

exec "$DOTNET_DIR/dotnet" "$@"
